pipeline {
    agent any 
    
    // Define shared parameters
    parameters {
        string(name: 'VERSION', defaultValue: 'latest', description: 'Docker image tag (e.g., v1.0.0)')
        string(name: 'DOCKER_REGISTRY', defaultValue: 'ghcr.io', description: 'Your Docker Registry URL (ghcr.io)')
        string(name: 'GITHUB_OWNER', defaultValue: 'gowthamlakshman94', description: 'GitHub username or organization for the GHCR image path.')
    }

    // Define shared environment variables
    environment {
        // Your specific GHCR credential ID
        DOCKER_CREDENTIAL_ID = 'ghcr-token'
    }

    stages {
        // --- Stage 1: Checkout Code ---
        stage('Checkout Code') {
            steps {
                echo "Cloning source code..."
                checkout scm 
            }
        }
        
        // --- Stage 2: Build and Push BOTH Services (Iterative Approach) ---
        stage('Build & Push All Services') {
            steps {
                script {
                    // Define the list of services to iterate over
                    def services = [
                        [name: 'sales-forecaster', path: './forecaster_job_dir'],
                        [name: 'sales-dashboard', path: './webapp']
                    ]

                    // Iterate over the list and perform the actions for each service
                    services.each { service ->
                        def REPO_NAME = service.name
                        def CONTEXT_PATH = service.path
                        def IMAGE_NAME = "${env.DOCKER_REGISTRY}/${params.GITHUB_OWNER}/${REPO_NAME}:${params.VERSION}"
                        
                        // --- BUILD ---
                        sh "echo 'Building Docker image: ${IMAGE_NAME} from path: ${CONTEXT_PATH}'"
                        sh "docker build -t ${IMAGE_NAME} ${CONTEXT_PATH}"
                        
                        // --- PUSH ---
                        sh "echo 'Logging into Docker Registry and pushing image...'"
                        withCredentials([usernamePassword(
                            credentialsId: env.DOCKER_CREDENTIAL_ID, 
                            usernameVariable: 'DOCKER_USER', 
                            passwordVariable: 'DOCKER_PASS')]) {
                            
                            sh "echo \$DOCKER_PASS | docker login ${env.DOCKER_REGISTRY} -u \$DOCKER_USER --password-stdin"
                            sh "docker push ${IMAGE_NAME}"
                        }
                        sh "echo 'Image Pushed Successfully: ${IMAGE_NAME}'"
                        
                        // --- CLEANUP ---
                        sh "docker rmi ${IMAGE_NAME}"
                    }
                }
            }
        }
    }
}
