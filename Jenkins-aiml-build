
pipeline {
    agent any 
    
    // Define shared parameters
    parameters {
        string(name: 'VERSION', defaultValue: 'latest', description: 'Docker image tag (e.g., v1.0.0)')
        string(name: 'DOCKER_REGISTRY', defaultValue: 'ghcr.io', description: 'Your Docker Registry URL (ghcr.io)')
        // NOTE: Replace this with your actual GitHub username or organization name
        string(name: 'GITHUB_OWNER', defaultValue: 'gowthamlakshman94', description: 'GitHub username or organization for the GHCR image path.')
    }

    // Define shared environment variables
    environment {
        // Your specific GHCR credential ID
        DOCKER_CREDENTIAL_ID = 'ghcr-token'
    }

    // --- Reusable Function to Build and Push a single service ---
    def buildAndPush(serviceName, contextPath) {
        script {
            // Define service-specific environment variables inside the function
            def REPO_NAME = serviceName
            def IMAGE_NAME = "${env.DOCKER_REGISTRY}/${params.GITHUB_OWNER}/${REPO_NAME}:${params.VERSION}"
            
            // --- Build ---
            stage("Build ${serviceName} Image") {
                echo "Building Docker image: ${IMAGE_NAME} from path: ${contextPath}"
                sh "docker build -t ${IMAGE_NAME} ${contextPath}"
            }
            
            // --- Push ---
            stage("Push ${serviceName} Image") {
                echo "Logging into Docker Registry and pushing image..."
                
                withCredentials([usernamePassword(
                    credentialsId: env.DOCKER_CREDENTIAL_ID, 
                    usernameVariable: 'DOCKER_USER', 
                    passwordVariable: 'DOCKER_PASS')]) {
                    
                    // Docker login
                    sh "echo \$DOCKER_PASS | docker login ${env.DOCKER_REGISTRY} -u \$DOCKER_USER --password-stdin"
                    
                    // Docker push
                    sh "docker push ${IMAGE_NAME}"
                }
                echo "Image Pushed Successfully: ${IMAGE_NAME}"
            }
            
            // --- Cleanup ---
            stage("Cleanup ${serviceName}") {
                sh "docker rmi ${IMAGE_NAME}"
            }
        }
    }

    stages {
        // --- Stage 1: Checkout Code ---
        stage('Checkout Code') {
            steps {
                echo "Cloning source code..."
                checkout scm 
            }
        }
        
        // --- Stage 2: Build and Push BOTH Services ---
        stage('Build & Push All Services') {
            steps {
                // 1. Build the Forecaster Job (Context: forecaster_job_dir/)
                buildAndPush('sales-forecaster', './forecaster_job_dir')
                
                // 2. Build the Web Dashboard (Context: webapp/)
                buildAndPush('sales-dashboard', './webapp')
            }
        }
        
        // --- Stage 3: Deployment Trigger (Placeholder) ---
        stage('Deploy to Kubernetes') {
            steps {
                echo "Deployment logic goes here (e.g., kubectl apply -f ... or using a Helm chart)"
                echo "Images built: sales-forecaster:${params.VERSION} and sales-dashboard:${params.VERSION}"
            }
        }
    }
}
