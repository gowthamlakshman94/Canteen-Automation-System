pipeline {
  agent {
    kubernetes {
      defaultContainer 'jnlp'
      yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: kubectl
    image: registry.k8s.io/kubectl:v1.30.0
    command: ['sh','-c']
    args: ['sleep 999d']
    tty: true
    volumeMounts:
    - name: shared-work
      mountPath: /shared
  - name: jnlp
    image: jenkins/inbound-agent:latest
    volumeMounts:
    - name: shared-work
      mountPath: /shared
  volumes:
  - name: shared-work
    emptyDir: {}
"""
    }
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Copy repo files to shared volume') {
      steps {
        sh '''
          set -euo pipefail
          cp -r ${WORKSPACE}/. /shared/
          echo "Copied repo into /shared"
          ls -la /shared || true
        '''
      }
    }

    stage('Inject kubeconfig into shared volume') {
      steps {
        withCredentials([file(credentialsId: 'k3s-config', variable: 'KUBEFILE')]) {
          sh '''
            set -euo pipefail
            echo "Kubefile in jnlp: ${KUBEFILE}"
            cp "${KUBEFILE}" /shared/kubeconfig
            chmod 644 /shared/kubeconfig
            ls -la /shared || true
          '''
        }
      }
    }

    stage('Deploy using kubectl container (reads /shared/kubeconfig)') {
      steps {
        container('kubectl') {
          sh '''
            sleep 2
            set -euo pipefail
            kubectl --kubeconfig=/shared/kubeconfig apply -f /shared/backend-deployment.yaml
            kubectl --kubeconfig=/shared/kubeconfig rollout status deployment/canteen-be -n canteen-automation --timeout=120s || true

            kubectl --kubeconfig=/shared/kubeconfig apply -f /shared/frontend-deployment.yaml
            kubectl --kubeconfig=/shared/kubeconfig rollout status deployment/canteen-fe -n canteen-automation --timeout=120s || true
          '''
        }
      }
    }
  }

  post {
    always {
      container('jnlp') {
        sh 'rm -f /shared/kubeconfig || true'
      }
    }
  }
}
