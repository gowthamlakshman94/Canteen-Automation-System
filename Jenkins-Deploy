pipeline {
  agent {
    kubernetes {
      defaultContainer 'jnlp'
      yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: kubectl
    image: bitnami/kubectl:latest
    command: ['sh','-c']
    args: ['sleep 999d']
    tty: true
    volumeMounts:
    - name: shared-work
      mountPath: /shared
  - name: jnlp
    image: jenkins/inbound-agent:latest
    volumeMounts:
    - name: shared-work
      mountPath: /shared
  volumes:
  - name: shared-work
    emptyDir: {}
"""
    }
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Inject kubeconfig into shared volume') {
      steps {
        // This runs in jnlp container (defaultContainer), injects the credential file and copies it to /shared/kubeconfig
        withCredentials([file(credentialsId: 'k3s-config', variable: 'KUBEFILE')]) {
          sh '''
            set -euo pipefail
            echo "Kubefile in jnlp: ${KUBEFILE}"
            mkdir -p /shared
            cp "${KUBEFILE}" /shared/kubeconfig
            chmod 644 /shared/kubeconfig
            ls -la /shared || true
          '''
        }
      }
    }

    stage('Deploy using kubectl container (reads /shared/kubeconfig)') {
      steps {
        container('kubectl') {
          sh '''
            set -euo pipefail
            echo "Using kubeconfig at $KUBECONFIG"
            kubectl --kubeconfig=/shared/kubeconfig apply -f backend-deployment.yaml
            kubectl --kubeconfig=/shared/kubeconfig rollout status deployment/canteen-be -n canteen-automation --timeout=120s || true
            kubectl --kubeconfig=/shared/kubeconfig apply -f frontend-deployment.yaml
            kubectl --kubeconfig=/shared/kubeconfig rollout status deployment/canteen-fe -n canteen-automation --timeout=120s || true
          '''
        }
      }
    }
  }

  post {
    always {
      // clean up shared file just in case
      container('jnlp') {
        sh 'rm -f /shared/kubeconfig || true'
      }
    }
  }
}
