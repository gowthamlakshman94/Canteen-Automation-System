<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Sales Forecast</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="config.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding:24px; max-width:1100px; margin:auto; background:#f7f7f7; }
    #controls { background:#fff; padding:16px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 4px rgba(0,0,0,0.08); }
    canvas { background:#fff; border-radius:8px; padding:12px; box-shadow:0 2px 4px rgba(0,0,0,0.08); width:100%; height:360px; }
    table { width:100%; background:#fff; border-collapse:collapse; }
    th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; }
    th { background:#f0f0f0; }
  </style>
</head>
<body>
  <h1>Sales Forecast</h1>
  <div id="controls">
    <label>
      Prediction Days:
      <select id="days"><option>7</option><option selected>14</option><option>30</option><option>60</option></select>
    </label>
    <button id="loadBtn">Load Forecast</button>
  </div>

  <canvas id="chart"></canvas>

  <h2>Recent History</h2>
  <table id="histTable"><thead><tr><th>Date</th><th>Sales (₹)</th></tr></thead><tbody></tbody></table>

<script>
  function getApiBase() {
    if (window && window.APP_CONFIG && typeof window.APP_CONFIG.API_BASE === 'string') return window.APP_CONFIG.API_BASE.replace(/\/+$/,'');
    return '';
  }
  const API = getApiBase();

  const ctx = document.getElementById('chart').getContext('2d');
  let chart = null;

  async function loadForecast(){
    const days = document.getElementById('days').value;
    const url = `${API}/api/forecast?days=${encodeURIComponent(days)}`;
    try {
      const resp = await fetch(url);
      const data = await resp.json();
      if (!resp.ok) { alert("Forecast error: "+(data.error||JSON.stringify(data))); return; }
      const labels = data.forecast.map(f => f.ds);
      const preds = data.forecast.map(f => Math.round(f.yhat));
      if (chart) chart.destroy();
      chart = new Chart(ctx, { type:'line', data:{ labels, datasets:[{ label:'Predicted Sales (₹)', data: preds, fill:false, tension:0.2 }] }, options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }});
      const tbody = document.querySelector('#histTable tbody'); tbody.innerHTML = '';
      (data.history||[]).forEach(r => { const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.ds}</td><td>${Math.round(r.y)}</td>`; tbody.appendChild(tr);});
    } catch (err) { console.error(err); alert('Failed to load forecast: '+err.message); }
  }

  document.getElementById('loadBtn').addEventListener('click', loadForecast);
  loadForecast();
</script>
</body>
</html>
