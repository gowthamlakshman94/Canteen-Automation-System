<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Menu Addition</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

  <style>
    body { padding: 24px; background: #f7f7f7; }
    .card { background:white; padding:20px; border-radius:8px; box-shadow: 0 2px 6px rgba(0,0,0,.08); }
    .preview { width:100%; max-width:320px; height:200px; object-fit:cover; border-radius:6px; border:1px solid #ddd; display:block; margin-bottom:8px; }
    .small-muted { font-size:12px; color:#666; }
    .required { color: #c00; }
    .topbar { margin-bottom: 18px; }
  </style>
</head>
<body>
  <!-- Optional top navbar -->
  <nav class="navbar navbar-inverse topbar">
    <div class="container">
      <div class="navbar-header">
        <a class="navbar-brand" href="#">IIT Patna Canteen — Admin</a>
      </div>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="breakfast.html">Breakfast</a></li>
        <li><a href="lunch.html">Lunch</a></li>
        <li><a href="dinner.html">Dinner</a></li>
        <li><a href="menu_addition.html">Add Menu</a></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <div class="row">
      <div class="col-md-8 col-md-offset-2 card">
        <h3>Menu Addition <small class="small-muted">(images are stored in DB)</small></h3>
        <hr/>

        <form id="addForm" autocomplete="off" novalidate>
          <div class="form-group">
            <label for="name">Name <span class="required">*</span></label>
            <input id="name" name="name" class="form-control" required placeholder="e.g. Aloo Paratha" />
          </div>

          <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" class="form-control" rows="2" placeholder="Short description"></textarea>
          </div>

          <div class="row">
            <div class="col-sm-6 form-group">
              <label for="price">Price (INR) <span class="required">*</span></label>
              <input id="price" name="price" type="number" step="0.01" min="0" class="form-control" required placeholder="e.g. 40.00" />
            </div>
            <div class="col-sm-6 form-group">
              <label for="category">Category</label>
              <select id="category" name="category" class="form-control">
                <option>Breakfast</option>
                <option>Lunch</option>
                <option>Dinner</option>
                <option>Snacks</option>
                <option>Other</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Availability</label>
            <select name="available" id="available" class="form-control">
              <option value="1">Available</option>
              <option value="0">Not available</option>
            </select>
          </div>

          <div class="form-group">
            <label>Image <small class="small-muted">(jpg/png/webp/gif — max 5MB)</small></label>
            <input id="image" name="image" type="file" accept="image/*" class="form-control" />
            <div style="margin-top:8px;">
              <img id="imgPreview" class="preview" src="placeholder.jpg" alt="preview" />
              <div id="imgInfo" class="small-muted">No file chosen</div>
            </div>
          </div>

          <div class="form-group" style="margin-top:12px;">
            <button id="submitBtn" class="btn btn-primary">Create item</button>
            <button id="resetBtn" type="button" class="btn btn-default">Reset</button>
          </div>
        </form>

        <div id="msg" style="margin-top:10px;"></div>

        <hr/>
        <p class="small-muted">Important: protect this admin page (login/auth) before deploying. This page posts directly to your backend `POST /api/menu` which should be admin-protected in production.</p>
      </div>
    </div>
  </div>

  <!-- JQuery + Bootstrap JS (required for Bootstrap components) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

  <!-- Page script -->
  <script>
  (function(){
    // Change API_BASE if your backend is hosted elsewhere
    const API_BASE = 'http://localhost:3000';
    const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
    const ALLOWED_TYPES = ['image/jpeg','image/png','image/webp','image/gif'];

    const form = document.getElementById('addForm');
    const imgInput = document.getElementById('image');
    const preview = document.getElementById('imgPreview');
    const imgInfo = document.getElementById('imgInfo');
    const msg = document.getElementById('msg');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn = document.getElementById('resetBtn');

    function showMessage(html, type='info', timeout = 5000) {
      const classes = { info: 'alert-info', success: 'alert-success', error: 'alert-danger' };
      msg.innerHTML = '<div class="alert ' + (classes[type] || 'alert-info') + '">' + html + '</div>';
      if (timeout) setTimeout(()=> { msg.innerHTML = ''; }, timeout);
    }

    // Image preview + validation
    imgInput.addEventListener('change', (e) => {
      const file = imgInput.files && imgInput.files[0];
      if (!file) {
        preview.src = 'placeholder.jpg';
        imgInfo.textContent = 'No file chosen';
        return;
      }

      if (file.size > MAX_FILE_SIZE) {
        showMessage('File too large. Max 5MB allowed.', 'error', 7000);
        imgInput.value = '';
        preview.src = 'placeholder.jpg';
        imgInfo.textContent = 'No file chosen';
        return;
      }

      if (!ALLOWED_TYPES.includes(file.type)) {
        showMessage('Invalid file type. Use JPG, PNG, GIF or WEBP.', 'error', 7000);
        imgInput.value = '';
        preview.src = 'placeholder.jpg';
        imgInfo.textContent = 'No file chosen';
        return;
      }

      // preview
      const reader = new FileReader();
      reader.onload = function(evt) {
        preview.src = evt.target.result;
      };
      reader.readAsDataURL(file);
      imgInfo.textContent = file.name + ' (' + Math.round(file.size/1024) + ' KB)';
    });

    resetBtn.addEventListener('click', () => {
      form.reset();
      preview.src = 'placeholder.jpg';
      imgInfo.textContent = 'No file chosen';
      msg.innerHTML = '';
    });

    // Submit form
    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      submitBtn.disabled = true;

      const name = form.name.value.trim();
      const price = form.price.value;
      if (!name || !price) {
        showMessage('Please provide both name and price.', 'error', 4000);
        submitBtn.disabled = false;
        return;
      }

      const data = new FormData();
      data.append('name', name);
      data.append('description', form.description.value || '');
      data.append('price', price);
      data.append('category', form.category.value || '');
      data.append('available', form.available.value);

      if (imgInput.files && imgInput.files[0]) data.append('image', imgInput.files[0]);

      try {
        const res = await fetch(API_BASE + '/api/menu', { method: 'POST', body: data });
        const json = await res.json().catch(()=>null);

        if (!res.ok) {
          const errMsg = (json && (json.message || json.error)) || res.statusText || 'Server error';
          showMessage('Server error: ' + errMsg, 'error', 7000);
          submitBtn.disabled = false;
          return;
        }

        if (json && json.success) {
          showMessage('Item added successfully. ID: ' + (json.data && json.data.id ? json.data.id : ''), 'success', 5000);
          form.reset();
          preview.src = 'placeholder.jpg';
          imgInfo.textContent = 'No file chosen';
        } else {
          showMessage('Error: ' + (json && (json.message || json.error) ? (json.message || json.error) : 'Unknown response'), 'error', 6000);
        }
      } catch (err) {
        console.error(err);
        showMessage('Network or server error.', 'error', 7000);
      } finally {
        submitBtn.disabled = false;
      }
    });
  })();
  </script>
</body>
</html>
