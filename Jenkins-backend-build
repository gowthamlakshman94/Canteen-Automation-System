// Jenkinsfile.backend
pipeline {
  agent {
    kubernetes {
      defaultContainer 'jnlp'
      yaml '''apiVersion: v1
kind: Pod
spec:
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:debug
    command: ['sh','-c']
    args: ['sleep 999d']
    tty: true
  volumes:
    - name: workspace
      emptyDir: {}
'''
    }
  }

  environment {
    REGISTRY = "ghcr.io/gowthamlakshman94"
    BACKEND_DIR  = "canteen-automation-backend"
    BACKEND_IMAGE  = "${REGISTRY}/cas-be:latest"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build & Push Backend') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'ghcr-token', usernameVariable: 'GHCR_USER', passwordVariable: 'GHCR_PASS')]) {
          container('kaniko') {
            dir("${env.BACKEND_DIR}") {
              sh '''
                set -euo pipefail
                mkdir -p /kaniko/.docker
                AUTH_B64=$(printf "%s:%s" "${GHCR_USER}" "${GHCR_PASS}" | base64 | tr -d '\\n')
                cat > /kaniko/.docker/config.json <<'EOF'
{"auths":{"ghcr.io":{"auth":"__AUTH__"}}}
EOF
                sed -i "s/__AUTH__/${AUTH_B64}/" /kaniko/.docker/config.json || true

                echo "Building backend -> ${BACKEND_IMAGE}"
                /kaniko/executor --context . --dockerfile Dockerfile --destination=${BACKEND_IMAGE} --verbosity info
              '''
            }
          }
        }
      }
    }
  }

  post {
    success {
      echo "✅ Backend build finished — image pushed as :latest"
    }
    failure {
      echo "❌ Backend build failed"
    }
  }
}
